<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Produtos Extraídos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap mínimo via CDN (layout semelhante ao atual) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  >

  <style>
    body {
      background: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .page-block {
      margin-bottom: 30px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,.05);
      padding: 16px 16px 8px;
    }
    .product-img {
      max-width: 90px;
      max-height: 90px;
      object-fit: contain;
      border-radius: 4px;
      border: 1px solid #ddd;
      background: #fafafa;
    }
    .table thead th {
      background: #f0f0f0;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
    }
    .table input {
      width: 100%;
      font-size: 0.85rem;
    }
    .page-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .top-summary {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,.05);
      padding: 16px 20px;
      margin-bottom: 24px;
    }
  </style>
</head>
<body>
<div class="container-fluid py-3">

  {# --- Variáveis tolerantes a diferentes nomes vindos do Flask --- #}
  {% set job =
        (job_id if job_id is defined else
         (jobid if jobid is defined else '') ) %}
  {% set supplier =
        (supplier_name if supplier_name is defined else
         (fornecedor if fornecedor is defined else '') ) %}

  {# pages_obj pode ser "pages" ou "pages_data", dependendo da rota #}
  {% if pages is defined %}
    {% set pages_obj = pages %}
  {% elif pages_data is defined %}
    {% set pages_obj = pages_data %}
  {% else %}
    {% set pages_obj = {} %}
  {% endif %}

  <div class="top-summary">
    <h3 class="mb-2">
      Produtos Extraídos
      {% if supplier %} – {{ supplier|upper }}{% endif %}
      {% if job %} ({{ job }}){% endif %}
    </h3>

    <p class="mb-1">
      <strong>Total de produtos extraídos:</strong>
      {% if total_products is defined and total_products %}
        {{ total_products }}
      {% else %}
        {# fallback: soma os tamanhos das páginas, se existirem #}
        {% set _total = 0 %}
        {% for _pg, _items in pages_obj.items() %}
          {% set _total = _total + (_items|length) %}
        {% endfor %}
        {{ _total }}
      {% endif %}
    </p>
    <p class="mb-0 text-muted">
      Divididos pelas páginas OCR detectadas.
    </p>

    <div class="mt-3">
      <button type="button" class="btn btn-primary btn-sm me-2" id="btnSaveAll">
        Salvar alterações
      </button>
      <button type="button" class="btn btn-success btn-sm" id="btnGenerateCatalog">
        Gerar Catálogo Final
      </button>
    </div>
  </div>

  {% if pages_obj and pages_obj|length > 0 %}
    {# garante ordenação crescente por número de página #}
    {% for page_num, items in pages_obj|dictsort %}
      {% set qtd = items|length %}
      <div class="page-block">
        <div class="page-title">
          Página {{ page_num }} – {{ qtd }} produto{% if qtd != 1 %}s{% endif %}
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th style="width: 110px;">Imagem</th>
                <th style="width: 120px;">Código</th>
                <th>Título</th>
                <th style="width: 120px;">Preço</th>
              </tr>
            </thead>
            <tbody>
            {% for p in items %}
              {# Mapeia campos aceitando formatos antigos e novos #}
              {% set codigo =
                   (p.codigo
                    or p.get('codigo')
                    or p.get('code')
                    or p.get('descricao')
                    or p.get('description')
                    or '') %}
              {% set titulo =
                   (p.titulo
                    or p.get('titulo')
                    or p.get('title')
                    or p.get('descricao')
                    or p.get('description')
                    or '') %}
              {% set preco =
                   (p.preco
                    or p.get('preco')
                    or p.get('price')
                    or p.get('raw_price')
                    or p.get('preco_raw')
                    or '') %}
              {% set imagem =
                   (p.imagem
                    or p.get('imagem')
                    or p.get('image')
                    or p.get('image_path')
                    or '') %}

              <tr data-page="{{ page_num }}" data-codigo="{{ codigo }}">
                <td>
                  {% if imagem %}
                    <img src="{{ imagem }}" alt="{{ codigo }}" class="product-img">
                  {% else %}
                    <span class="text-muted" style="font-size:0.8rem;">(sem imagem)</span>
                  {% endif %}
                </td>
                <td>
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    name="codigo"
                    value="{{ codigo }}"
                  >
                </td>
                <td>
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    name="titulo"
                    value="{{ titulo }}"
                  >
                </td>
                <td>
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    name="preco"
                    value="{{ preco }}"
                  >
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-warning">
      Nenhum dado encontrado. Execute a extração de dados antes de acessar esta tela.
    </div>
  {% endif %}
</div>

<!-- Opcional: espaço para JS de salvar/gerar catálogo.
     Mantive apenas IDs btnSaveAll e btnGenerateCatalog para
     compatibilidade com scripts existentes. -->
</body>
</html>